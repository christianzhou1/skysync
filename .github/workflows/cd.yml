name: Continuous Delivery

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build backend
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build:ci

      - name: Generate .env.production
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          S3_PREFIX: ${{ secrets.S3_PREFIX }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          STORAGE_TYPE: ${{ secrets.STORAGE_TYPE }}
          MAX_FILE_SIZE: ${{ secrets.MAX_FILE_SIZE }}
          MAX_REQUEST_SIZE: ${{ secrets.MAX_REQUEST_SIZE }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_IP: ${{ secrets.VPS_IP }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          cat > .env.production << EOF
          DATABASE_URL=${DATABASE_URL}
          DATABASE_USERNAME=${DATABASE_USERNAME}
          DATABASE_PASSWORD=${DATABASE_PASSWORD}
          JWT_SECRET=${JWT_SECRET}
          AWS_REGION=${AWS_REGION}
          AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
          AWS_SECRET_KEY=${AWS_SECRET_KEY}
          S3_BUCKET_NAME=${S3_BUCKET_NAME}
          S3_PREFIX=${S3_PREFIX}
          SERVER_PORT=${SERVER_PORT}
          STORAGE_TYPE=${STORAGE_TYPE}
          MAX_FILE_SIZE=${MAX_FILE_SIZE}
          MAX_REQUEST_SIZE=${MAX_REQUEST_SIZE}
          VPS_USER=${VPS_USER}
          VPS_IP=${VPS_IP}
          VPS_HOST=${VPS_HOST}
          APP_DIR=${APP_DIR}
          EOF

      - name: Prepare deployment
        run: |
          mkdir -p deployment
          cp docker-compose.prod.yml deployment/
          cp Dockerfile.jar deployment/
          cp target/todo-0.0.1-SNAPSHOT.jar deployment/
          cp .env.production deployment/
          cp -r frontend/dist deployment/frontend/
          [ -f nginx-ssl.conf ] && cp nginx-ssl.conf deployment/nginx.conf || cp nginx.conf deployment/

      - name: Validate deployment secrets
        run: |
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "ERROR: VPS_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "ERROR: VPS_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.APP_DIR }}" ]; then
            echo "ERROR: APP_DIR secret is not set"
            exit 1
          fi
          echo "âœ“ All required deployment secrets are configured"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          log-public-key: true

      - name: Upload files
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          echo "Uploading files to ${VPS_USER}@${VPS_HOST}:${APP_DIR}/"
          scp -o StrictHostKeyChecking=no deployment/* ${VPS_USER}@${VPS_HOST}:${APP_DIR}/
          scp -o StrictHostKeyChecking=no -r deployment/frontend ${VPS_USER}@${VPS_HOST}:${APP_DIR}/
          scp -o StrictHostKeyChecking=no deploy-remote.sh ${VPS_USER}@${VPS_HOST}:/tmp/deploy-remote.sh

      - name: Deploy
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          echo "Deploying to ${VPS_USER}@${VPS_HOST}"
          ssh -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} \
            "chmod +x /tmp/deploy-remote.sh && /tmp/deploy-remote.sh ${APP_DIR} false && rm /tmp/deploy-remote.sh"
